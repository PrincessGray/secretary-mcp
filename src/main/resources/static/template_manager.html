<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP秘书系统 - 模板管理器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .panel {
            flex: 1;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        h2 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background-color: #45a049;
        }
        .list-item {
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .list-item:hover {
            background-color: #f9f9f9;
        }
        .list-item h3 {
            margin-top: 0;
            margin-bottom: 5px;
        }
        .actions {
            margin-top: 10px;
        }
        .error {
            color: #D8000C;
            background-color: #FFBABA;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }
        .success {
            color: #4F8A10;
            background-color: #DFF2BF;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow: auto;
        }
        .request-log {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }
        .tab-container {
            margin-bottom: 20px;
        }
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ccc;
        }
        .tab-button {
            padding: 10px 15px;
            background-color: #f1f1f1;
            border: none;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .tab-button.active {
            background-color: #4CAF50;
            color: white;
        }
        .tab-content {
            display: none;
            padding: 15px;
            border: 1px solid #ccc;
            border-top: none;
        }
        .tab-content.active {
            display: block;
        }
        .custom-params-container {
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .custom-param-item {
            background-color: #f9f9f9;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            position: relative;
        }
        .remove-param {
            position: absolute;
            right: 10px;
            top: 10px;
            background-color: #f44336;
            color: white;
            border: none;
            width: 24px;
            height: 24px;
            border-radius: 12px;
            cursor: pointer;
        }
        .nav-links {
            margin-bottom: 20px;
        }
        .nav-links a {
            display: inline-block;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            margin-right: 10px;
        }
        .nav-links a:hover {
            background-color: #0056b3;
        }
        .sub-form {
            margin-left: 20px;
            padding-left: 10px;
            border-left: 3px solid #ccc;
        }
    </style>
</head>
<body>
    <div class="nav-links">
        <a href="index.html">首页</a>
        <a href="template_manager.html">模板管理器</a>
        <a href="secretary_manager.html">秘书任务管理器</a>
    </div>

    <h1>MCP秘书系统 - 模板管理器</h1>
    
    <div id="alerts">
        <div id="errorAlert" class="error"></div>
        <div id="successAlert" class="success"></div>
    </div>
    
    <div class="container">
        <div class="panel">
            <h2>模板列表</h2>
            <div class="form-group">
                <button id="loadTemplates">加载所有模板</button>
            </div>
            
            <div id="templateList"></div>
        </div>
        
        <div class="panel">
            <h2>创建新模板</h2>
            
            <div class="tab-container">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="openTab(event, 'basicInfoTab')">基本信息</button>
                    <button class="tab-button" onclick="openTab(event, 'connectionTab')">连接配置</button>
                    <button class="tab-button" onclick="openTab(event, 'customParamsTab')">可定制参数</button>
                </div>
                
                <div id="basicInfoTab" class="tab-content active">
                    <div class="form-group">
                        <label for="templateName">模板名称 *</label>
                        <input type="text" id="templateName" placeholder="输入模板名称" required>
                    </div>
                    <div class="form-group">
                        <label for="templateDesc">模板描述</label>
                        <textarea id="templateDesc" placeholder="输入模板描述"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="connectionType">连接类型 *</label>
                        <select id="connectionType" onchange="updateConnectionForm()">
                            <option value="stdio">标准输入输出 (STDIO)</option>
                            <option value="sse">服务器发送事件 (SSE)</option>
                        </select>
                    </div>
                </div>
                
                <div id="connectionTab" class="tab-content">
                    <!-- STDIO连接配置 -->
                    <div id="stdioConfig">
                        <div class="form-group">
                            <label for="stdioCommand">命令 *</label>
                            <input type="text" id="stdioCommand" placeholder="输入命令" required>
                        </div>
                        <div class="form-group">
                            <label for="stdioArgs">命令参数 (一行一个)</label>
                            <textarea id="stdioArgs" placeholder="每行一个参数"></textarea>
                        </div>
                        <div class="form-group">
                            <label>环境变量</label>
                            <div id="stdioEnvVars">
                                <div class="form-group" style="display: flex; gap: 10px;">
                                    <input type="text" placeholder="名称" class="env-name" style="flex: 1;">
                                    <input type="text" placeholder="值" class="env-value" style="flex: 1;">
                                    <button onclick="removeEnvVar(this)" style="width: auto; background-color: #f44336;">删除</button>
                                </div>
                            </div>
                            <button onclick="addEnvVar()" style="margin-top: 10px;">添加环境变量</button>
                        </div>
                    </div>
                    
                    <!-- SSE连接配置 -->
                    <div id="sseConfig" style="display: none;">
                        <div class="form-group">
                            <label for="sseServerUrl">服务器URL *</label>
                            <input type="text" id="sseServerUrl" placeholder="输入服务器URL" required>
                        </div>
                        <div class="form-group">
                            <label for="sseAuthToken">认证Token</label>
                            <input type="text" id="sseAuthToken" placeholder="输入认证Token">
                        </div>
                        <div class="form-group">
                            <label>自定义请求头</label>
                            <div id="sseHeaders">
                                <div class="form-group" style="display: flex; gap: 10px;">
                                    <input type="text" placeholder="名称" class="header-name" style="flex: 1;">
                                    <input type="text" placeholder="值" class="header-value" style="flex: 1;">
                                    <button onclick="removeHeader(this)" style="width: auto; background-color: #f44336;">删除</button>
                                </div>
                            </div>
                            <button onclick="addHeader()" style="margin-top: 10px;">添加请求头</button>
                        </div>
                    </div>
                    
                    <!-- 通用配置 -->
                    <div class="form-group">
                        <label for="timeoutSeconds">超时时间 (秒)</label>
                        <input type="number" id="timeoutSeconds" placeholder="默认: 60" min="1">
                    </div>
                    <div class="form-group">
                        <label for="enableRoots">启用Roots功能</label>
                        <select id="enableRoots">
                            <option value="false">否</option>
                            <option value="true">是</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="enableSampling">启用采样功能</label>
                        <select id="enableSampling">
                            <option value="false">否</option>
                            <option value="true">是</option>
                        </select>
                    </div>
                </div>
                
                <div id="customParamsTab" class="tab-content">
                    <h3>添加可定制参数</h3>
                    <div class="form-group">
                        <label for="paramCategory">参数类别</label>
                        <select id="paramCategory" onchange="updateParamForm()">
                            <option value="STDIO_ENV">STDIO环境变量</option>
                            <option value="STDIO_ARG">STDIO命令行参数(开关)</option>
                            <option value="SSE_AUTH_PARAM">SSE认证参数</option>
                        </select>
                    </div>
                    
                    <!-- STDIO环境变量参数表单 -->
                    <div id="envParamForm">
                        <div class="form-group">
                            <label for="envParamName">环境变量名 *</label>
                            <small style="display: block; color: #666;">环境变量的名称，例如：API_KEY、DEBUG_LEVEL</small>
                            <input type="text" id="envParamName" placeholder="例如：API_KEY" required>
                        </div>
                        <div class="form-group">
                            <label for="envParamDisplayName">显示名称 *</label>
                            <small style="display: block; color: #666;">在用户界面显示的友好名称</small>
                            <input type="text" id="envParamDisplayName" placeholder="例如：API密钥" required>
                        </div>
                        <div class="form-group">
                            <label for="envParamDesc">描述</label>
                            <textarea id="envParamDesc" placeholder="描述此环境变量的作用"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="envParamDefault">默认值</label>
                            <input type="text" id="envParamDefault" placeholder="默认的环境变量值">
                        </div>
                        <div class="form-group">
                            <label for="envParamRequired">是否必填</label>
                            <select id="envParamRequired">
                                <option value="false">否</option>
                                <option value="true">是</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- STDIO命令行参数表单 -->
                    <div id="argParamForm" style="display: none;">
                        <div class="form-group">
                            <label for="argParamName">命令行参数 *</label>
                            <small style="display: block; color: #666;">完整的命令行参数，例如：--verbose、-d</small>
                            <input type="text" id="argParamName" placeholder="例如：--verbose" required>
                        </div>
                        <div class="form-group">
                            <label for="argParamDisplayName">显示名称 *</label>
                            <small style="display: block; color: #666;">在用户界面显示的友好名称</small>
                            <input type="text" id="argParamDisplayName" placeholder="例如：详细日志模式" required>
                        </div>
                        <div class="form-group">
                            <label for="argParamDesc">描述</label>
                            <textarea id="argParamDesc" placeholder="描述此命令行参数的作用"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="argParamDefault">默认是否启用</label>
                            <div class="switch-label">
                                <label class="switch">
                                    <input type="checkbox" id="argParamDefault">
                                    <span class="slider"></span>
                                </label>
                                <span id="argDefaultStatus">禁用</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- SSE认证参数表单 -->
                    <div id="sseParamForm" style="display: none;">
                        <div class="form-group">
                            <label for="sseParamName">认证参数名 *</label>
                            <small style="display: block; color: #666;">认证参数的名称，例如：apiKey、authToken</small>
                            <input type="text" id="sseParamName" placeholder="例如：apiKey" required>
                        </div>
                        <div class="form-group">
                            <label for="sseParamDisplayName">显示名称 *</label>
                            <small style="display: block; color: #666;">在用户界面显示的友好名称</small>
                            <input type="text" id="sseParamDisplayName" placeholder="例如：API密钥" required>
                        </div>
                        <div class="form-group">
                            <label for="sseParamDesc">描述</label>
                            <textarea id="sseParamDesc" placeholder="描述此认证参数的作用"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="sseParamDefault">默认值</label>
                            <input type="text" id="sseParamDefault" placeholder="默认的认证参数值">
                        </div>
                        <div class="form-group">
                            <label for="sseParamRequired">是否必填</label>
                            <select id="sseParamRequired">
                                <option value="false">否</option>
                                <option value="true">是</option>
                            </select>
                        </div>
                    </div>
                    
                    <button onclick="addCustomParam()">添加参数</button>
                    
                    <h3>已添加的可定制参数</h3>
                    <div id="customParamsList" class="custom-params-container">
                        <p>还没有添加参数</p>
                    </div>
                </div>
            </div>
            
            <div class="form-group" style="margin-top: 20px;">
                <button id="createTemplate" onclick="createTemplate()">创建模板</button>
            </div>
        </div>
    </div>
    
    <div class="panel">
        <h2>API响应</h2>
        <div class="request-log" id="requestLog"></div>
        <pre id="apiResponse">点击任意操作按钮查看API响应...</pre>
    </div>

    <script>
        // API基础URL - 确保与后端匹配
        const API_BASE_URL = 'http://localhost:8080/api';
        
        // DOM元素引用
        const errorAlert = document.getElementById('errorAlert');
        const successAlert = document.getElementById('successAlert');
        const apiResponse = document.getElementById('apiResponse');
        const requestLog = document.getElementById('requestLog');
        const templateList = document.getElementById('templateList');
        
        // 显示错误信息
        function showError(message) {
            errorAlert.textContent = message;
            errorAlert.style.display = 'block';
            setTimeout(() => {
                errorAlert.style.display = 'none';
            }, 5000);
        }
        
        // 显示成功信息
        function showSuccess(message) {
            successAlert.textContent = message;
            successAlert.style.display = 'block';
            setTimeout(() => {
                successAlert.style.display = 'none';
            }, 3000);
        }
        
        // 显示API响应
        function displayApiResponse(data) {
            apiResponse.textContent = JSON.stringify(data, null, 2);
        }
        
        // 记录请求日志
        function logRequest(method, url, body, status, response) {
            const timestamp = new Date().toLocaleTimeString();
            const log = `${timestamp} - ${method} ${url} - 状态: ${status}\n`;
            requestLog.textContent = log + requestLog.textContent;
            
            console.log(`API请求: ${method} ${url}`);
            if (body) console.log('请求体:', body);
            console.log(`响应状态: ${status}`);
            console.log('响应内容:', response);
        }
        
        // 执行API请求
        async function fetchApi(endpoint, method = 'GET', body = null) {
            const url = `${API_BASE_URL}${endpoint}`;
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include' // 包含cookies
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }
                
                // 记录请求日志
                console.log(`发送${method}请求到: ${url}`, body);
                
                const response = await fetch(url, options);
                
                let responseData;
                let responseText = '';
                
                try {
                    responseText = await response.text();
                    if (responseText) {
                        responseData = JSON.parse(responseText);
                    }
                } catch (e) {
                    responseData = { text: responseText };
                    console.warn('无法解析响应为JSON:', e);
                }
                
                // 记录响应日志
                logRequest(method, url, body, response.status, responseData || responseText);
                
                if (!response.ok) {
                    throw new Error(
                        responseData?.message || 
                        responseData?.error || 
                        `API错误: ${response.status} - ${responseText}`
                    );
                }
                
                // 204 No Content不需要解析JSON
                if (response.status === 204) {
                    return { success: true, statusCode: 204 };
                }
                
                return responseData;
            } catch (error) {
                console.error('API请求失败:', error);
                showError(`请求失败: ${error.message}`);
                throw error;
            }
        }
        
        // 加载所有模板
        async function loadTemplates() {
            try {
                const templates = await fetchApi('/templates');
                displayApiResponse(templates);
                
                // 清空模板列表
                templateList.innerHTML = '';
                
                // 填充模板列表
                templates.forEach(template => {
                    const templateItem = document.createElement('div');
                    templateItem.className = 'list-item';
                    templateItem.innerHTML = `
                        <h3>${template.name}</h3>
                        <p>${template.description || '无描述'}</p>
                        <p>连接类型: ${template.connectionType}</p>
                        <div class="actions">
                            <button onclick="viewTemplate('${template.id}')">查看详情</button>
                            <button onclick="deleteTemplate('${template.id}')" style="background-color: #f44336;">删除</button>
                        </div>
                    `;
                    templateList.appendChild(templateItem);
                });
                
                showSuccess('成功加载模板列表');
            } catch (error) {
                console.error('加载模板失败:', error);
                displayApiResponse({ error: error.message });
            }
        }
        
        // 查看模板详情
        async function viewTemplate(id) {
            try {
                const template = await fetchApi(`/templates/${id}`);
                displayApiResponse(template);
            } catch (error) {
                console.error('获取模板详情失败:', error);
                displayApiResponse({ error: error.message });
            }
        }
        
        // 删除模板
        async function deleteTemplate(id) {
            if (!confirm('确定要删除这个模板吗？此操作不可撤销。')) {
                return;
            }
            
            try {
                await fetchApi(`/templates/${id}`, 'DELETE');
                showSuccess('模板删除成功');
                displayApiResponse({ success: true, message: '模板删除成功' });
                loadTemplates(); // 重新加载列表
            } catch (error) {
                console.error('删除模板失败:', error);
                displayApiResponse({ error: error.message });
            }
        }
        
        // 创建新模板
        async function createTemplate() {
            // 收集基本信息
            const name = document.getElementById('templateName').value.trim();
            const description = document.getElementById('templateDesc').value.trim();
            const connectionType = document.getElementById('connectionType').value;
            
            if (!name) {
                showError('模板名称不能为空');
                return;
            }
            
            // 构建请求数据
            const templateData = {
                name,
                description,
                connectionType
            };
            
            // 根据连接类型收集特定配置
            if (connectionType === 'stdio') {
                const command = document.getElementById('stdioCommand').value.trim();
                if (!command) {
                    showError('STDIO命令不能为空');
                    return;
                }
                
                templateData.stdioCommand = command;
                
                // 命令参数
                const argsText = document.getElementById('stdioArgs').value.trim();
                if (argsText) {
                    templateData.stdioArgs = argsText.split('\n').filter(arg => arg.trim() !== '');
                }
                
                // 环境变量
                const envVars = {};
                const envElements = document.querySelectorAll('#stdioEnvVars .form-group');
                envElements.forEach(el => {
                    const name = el.querySelector('.env-name').value.trim();
                    const value = el.querySelector('.env-value').value.trim();
                    if (name && value) {
                        envVars[name] = value;
                    }
                });
                
                if (Object.keys(envVars).length > 0) {
                    templateData.stdioEnv = envVars;
                }
            } else if (connectionType === 'sse') {
                const serverUrl = document.getElementById('sseServerUrl').value.trim();
                if (!serverUrl) {
                    showError('SSE服务器URL不能为空');
                    return;
                }
                
                templateData.sseServerUrl = serverUrl;
                
                // 认证Token
                const authToken = document.getElementById('sseAuthToken').value.trim();
                if (authToken) {
                    templateData.sseAuthToken = authToken;
                }
                
                // 自定义请求头
                const headers = {};
                const headerElements = document.querySelectorAll('#sseHeaders .form-group');
                headerElements.forEach(el => {
                    const name = el.querySelector('.header-name').value.trim();
                    const value = el.querySelector('.header-value').value.trim();
                    if (name && value) {
                        headers[name] = value;
                    }
                });
                
                if (Object.keys(headers).length > 0) {
                    templateData.sseHeaders = headers;
                }
            }
            
            // 添加通用配置
            const timeoutSeconds = parseInt(document.getElementById('timeoutSeconds').value, 10);
            if (!isNaN(timeoutSeconds) && timeoutSeconds > 0) {
                templateData.timeoutSeconds = timeoutSeconds;
            }
            
            templateData.enableRoots = document.getElementById('enableRoots').value === 'true';
            templateData.enableSampling = document.getElementById('enableSampling').value === 'true';
            
            // 添加自定义参数
            const customParams = [];
            const paramElements = document.querySelectorAll('#customParamsList .custom-param-item');
            paramElements.forEach(el => {
                const param = JSON.parse(el.dataset.param);
                
                // 根据类别自动设置类型
                if (param.category === 'STDIO_ARG') {
                    param.type = 'boolean';
                } else if (param.category === 'SSE_AUTH_PARAM') {
                    param.type = 'string';
                }
                
                customParams.push(param);
            });
            
            if (customParams.length > 0) {
                templateData.customizableParams = customParams;
            }
            
            try {
                const newTemplate = await fetchApi('/templates', 'POST', templateData);
                displayApiResponse(newTemplate);
                showSuccess('模板创建成功');
                
                // 重新加载模板列表
                loadTemplates();
                
                // 清空表单
                resetTemplateForm();
            } catch (error) {
                console.error('创建模板失败:', error);
                displayApiResponse({ error: error.message });
            }
        }
        
        // 重置模板表单
        function resetTemplateForm() {
            document.getElementById('templateName').value = '';
            document.getElementById('templateDesc').value = '';
            document.getElementById('connectionType').value = 'stdio';
            document.getElementById('stdioCommand').value = '';
            document.getElementById('stdioArgs').value = '';
            document.getElementById('stdioEnvVars').innerHTML = `
                <div class="form-group" style="display: flex; gap: 10px;">
                    <input type="text" placeholder="名称" class="env-name" style="flex: 1;">
                    <input type="text" placeholder="值" class="env-value" style="flex: 1;">
                    <button onclick="removeEnvVar(this)" style="width: auto; background-color: #f44336;">删除</button>
                </div>
            `;
            document.getElementById('sseServerUrl').value = '';
            document.getElementById('sseAuthToken').value = '';
            document.getElementById('sseHeaders').innerHTML = `
                <div class="form-group" style="display: flex; gap: 10px;">
                    <input type="text" placeholder="名称" class="header-name" style="flex: 1;">
                    <input type="text" placeholder="值" class="header-value" style="flex: 1;">
                    <button onclick="removeHeader(this)" style="width: auto; background-color: #f44336;">删除</button>
                </div>
            `;
            document.getElementById('timeoutSeconds').value = '';
            document.getElementById('enableRoots').value = 'false';
            document.getElementById('enableSampling').value = 'false';
            document.getElementById('customParamsList').innerHTML = '<p>还没有添加参数</p>';
            
            // 重置选项卡
            openTab(null, 'basicInfoTab');
            
            // 更新连接表单
            updateConnectionForm();
        }
        
        // 打开选项卡
        function openTab(evt, tabName) {
            // 隐藏所有选项卡内容
            const tabContents = document.getElementsByClassName('tab-content');
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove('active');
            }
            
            // 移除所有按钮的活动状态
            const tabButtons = document.getElementsByClassName('tab-button');
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove('active');
            }
            
            // 显示当前选项卡内容并激活按钮
            document.getElementById(tabName).classList.add('active');
            if (evt) {
                evt.currentTarget.classList.add('active');
            } else {
                // 默认激活第一个按钮
                document.querySelector('.tab-button').classList.add('active');
            }
        }
        
        // 更新连接表单
        function updateConnectionForm() {
            const connectionType = document.getElementById('connectionType').value;
            
            if (connectionType === 'stdio') {
                document.getElementById('stdioConfig').style.display = 'block';
                document.getElementById('sseConfig').style.display = 'none';
            } else {
                document.getElementById('stdioConfig').style.display = 'none';
                document.getElementById('sseConfig').style.display = 'block';
            }
        }
        
        // 添加环境变量
        function addEnvVar() {
            const envVarsContainer = document.getElementById('stdioEnvVars');
            const newEnvVar = document.createElement('div');
            newEnvVar.className = 'form-group';
            newEnvVar.style.display = 'flex';
            newEnvVar.style.gap = '10px';
            
            newEnvVar.innerHTML = `
                <input type="text" placeholder="名称" class="env-name" style="flex: 1;">
                <input type="text" placeholder="值" class="env-value" style="flex: 1;">
                <button onclick="removeEnvVar(this)" style="width: auto; background-color: #f44336;">删除</button>
            `;
            
            envVarsContainer.appendChild(newEnvVar);
        }
        
        // 删除环境变量
        function removeEnvVar(button) {
            const envVar = button.parentElement;
            envVar.remove();
        }
        
        // 添加请求头
        function addHeader() {
            const headersContainer = document.getElementById('sseHeaders');
            const newHeader = document.createElement('div');
            newHeader.className = 'form-group';
            newHeader.style.display = 'flex';
            newHeader.style.gap = '10px';
            
            newHeader.innerHTML = `
                <input type="text" placeholder="名称" class="header-name" style="flex: 1;">
                <input type="text" placeholder="值" class="header-value" style="flex: 1;">
                <button onclick="removeHeader(this)" style="width: auto; background-color: #f44336;">删除</button>
            `;
            
            headersContainer.appendChild(newHeader);
        }
        
        // 删除请求头
        function removeHeader(button) {
            const header = button.parentElement;
            header.remove();
        }
        
        // 更新参数表单显示
        function updateParamForm() {
            const category = document.getElementById('paramCategory').value;
            
            // 隐藏所有表单
            document.getElementById('envParamForm').style.display = 'none';
            document.getElementById('argParamForm').style.display = 'none';
            document.getElementById('sseParamForm').style.display = 'none';
            
            // 显示对应类别的表单
            switch(category) {
                case 'STDIO_ENV':
                    document.getElementById('envParamForm').style.display = 'block';
                    break;
                case 'STDIO_ARG':
                    document.getElementById('argParamForm').style.display = 'block';
                    break;
                case 'SSE_AUTH_PARAM':
                    document.getElementById('sseParamForm').style.display = 'block';
                    break;
            }
        }
        
        // 监听命令行参数默认值复选框变化
        document.getElementById('argParamDefault').addEventListener('change', function() {
            document.getElementById('argDefaultStatus').textContent = this.checked ? '启用' : '禁用';
        });
        
        // 添加自定义参数
        function addCustomParam() {
            const category = document.getElementById('paramCategory').value;
            
            let name, displayName, description, defaultValue, required;
            
            // 根据类别获取不同表单的输入
            switch(category) {
                case 'STDIO_ENV':
                    name = document.getElementById('envParamName').value.trim();
                    displayName = document.getElementById('envParamDisplayName').value.trim();
                    description = document.getElementById('envParamDesc').value.trim();
                    defaultValue = document.getElementById('envParamDefault').value.trim();
                    required = document.getElementById('envParamRequired').value === 'true';
                    break;
                case 'STDIO_ARG':
                    name = document.getElementById('argParamName').value.trim();
                    displayName = document.getElementById('argParamDisplayName').value.trim();
                    description = document.getElementById('argParamDesc').value.trim();
                    defaultValue = document.getElementById('argParamDefault').checked;
                    required = false; // 命令行参数不需要"是否必填"，设为默认值
                    break;
                case 'SSE_AUTH_PARAM':
                    name = document.getElementById('sseParamName').value.trim();
                    displayName = document.getElementById('sseParamDisplayName').value.trim();
                    description = document.getElementById('sseParamDesc').value.trim();
                    defaultValue = document.getElementById('sseParamDefault').value.trim();
                    required = document.getElementById('sseParamRequired').value === 'true';
                    break;
            }
            
            if (!name || !displayName) {
                showError('参数名称和显示名称不能为空');
                return;
            }
            
            // 根据类别设置类型
            let type;
            if (category === 'STDIO_ARG') {
                type = 'boolean';
            } else {
                type = 'string';
            }
            
            const param = {
                name,
                displayName,
                description,
                type,
                defaultValue: defaultValue || null,
                required,
                category
            };
            
            // 添加到参数列表
            const paramsList = document.getElementById('customParamsList');
            
            // 如果是第一个参数，清空占位文本
            if (paramsList.innerHTML.includes('还没有添加参数')) {
                paramsList.innerHTML = '';
            }
            
            const paramItem = document.createElement('div');
            paramItem.className = 'custom-param-item';
            paramItem.dataset.param = JSON.stringify(param);
            
            paramItem.innerHTML = `
                <strong>${displayName}</strong> (${name})<br>
                类别: ${getCategoryName(category)}<br>
                类型: ${param.type}<br>
                ${description ? `描述: ${description}<br>` : ''}
                默认值: ${defaultValue || '无'}<br>
                必填: ${required ? '是' : '否'}
                <button onclick="removeCustomParam(this)" class="remove-param">×</button>
            `;
            
            paramsList.appendChild(paramItem);
            
            // 清空表单
            document.getElementById('envParamName').value = '';
            document.getElementById('envParamDisplayName').value = '';
            document.getElementById('envParamDesc').value = '';
            document.getElementById('envParamDefault').value = '';
            document.getElementById('envParamRequired').value = 'false';
            document.getElementById('argParamName').value = '';
            document.getElementById('argParamDisplayName').value = '';
            document.getElementById('argParamDesc').value = '';
            document.getElementById('argParamDefault').checked = false;
            document.getElementById('sseParamName').value = '';
            document.getElementById('sseParamDisplayName').value = '';
            document.getElementById('sseParamDesc').value = '';
            document.getElementById('sseParamDefault').value = '';
            document.getElementById('sseParamRequired').value = 'false';
        }
        
        // 删除自定义参数
        function removeCustomParam(button) {
            const paramItem = button.parentElement;
            paramItem.remove();
            
            // 如果没有参数了，显示占位文本
            const paramsList = document.getElementById('customParamsList');
            if (paramsList.children.length === 0) {
                paramsList.innerHTML = '<p>还没有添加参数</p>';
            }
        }
        
        // 获取类别名称
        function getCategoryName(category) {
            switch (category) {
                case 'STDIO_ENV': return 'STDIO环境变量';
                case 'STDIO_ARG': return 'STDIO命令行参数(仅启用/禁用)';
                case 'SSE_AUTH_PARAM': return 'SSE认证参数';
                default: return category;
            }
        }
        
        // 添加一个简单的尝试连接函数
        async function testConnection() {
            try {
                const result = await fetch(API_BASE_URL + '/templates', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'include'
                });
                
                const status = result.status;
                let response = '';
                
                try {
                    response = await result.text();
                } catch (e) {
                    response = '无响应内容';
                }
                
                displayApiResponse({
                    status: status,
                    responseText: response
                });
                
                if (result.ok) {
                    showSuccess('连接测试成功!');
                } else {
                    showError(`连接测试失败: ${status}`);
                }
            } catch (error) {
                console.error('连接测试失败:', error);
                displayApiResponse({ error: error.message });
                showError(`连接测试失败: ${error.message}`);
            }
        }
        
        // 页面加载时执行
        document.addEventListener('DOMContentLoaded', function() {
            // 添加一个连接测试按钮
            const testButton = document.createElement('button');
            testButton.textContent = '测试API连接';
            testButton.style.marginBottom = '20px';
            testButton.style.backgroundColor = '#007bff';
            testButton.onclick = testConnection;
            document.body.insertBefore(testButton, document.querySelector('.container'));
            
            // 按钮事件监听
            document.getElementById('loadTemplates').addEventListener('click', loadTemplates);
            
            // 初始化 - 加载模板列表并设置表单默认值
            updateConnectionForm();
            loadTemplates();
            testConnection();
        });
        
        // 暴露函数给全局作用域，以便HTML中的onclick调用
        window.viewTemplate = viewTemplate;
        window.deleteTemplate = deleteTemplate;
        window.createTemplate = createTemplate;
        window.openTab = openTab;
        window.updateConnectionForm = updateConnectionForm;
        window.addEnvVar = addEnvVar;
        window.removeEnvVar = removeEnvVar;
        window.addHeader = addHeader;
        window.removeHeader = removeHeader;
        window.addCustomParam = addCustomParam;
        window.removeCustomParam = removeCustomParam;
        window.testConnection = testConnection;
    </script>
</body>
</html> 