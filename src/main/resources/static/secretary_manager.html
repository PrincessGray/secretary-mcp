<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP秘书系统 - 秘书任务管理器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .panel {
            flex: 1;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        h2 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background-color: #45a049;
        }
        .list-item {
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .list-item:hover {
            background-color: #f9f9f9;
        }
        .list-item h3 {
            margin-top: 0;
            margin-bottom: 5px;
        }
        .actions {
            margin-top: 10px;
        }
        .error {
            color: #D8000C;
            background-color: #FFBABA;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }
        .success {
            color: #4F8A10;
            background-color: #DFF2BF;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow: auto;
        }
        .request-log {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }
        .badge {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 12px;
            color: white;
        }
        .badge-active {
            background-color: #4CAF50;
        }
        .badge-inactive {
            background-color: #9e9e9e;
        }
        .badge-error {
            background-color: #f44336;
        }
        .task-status {
            margin-left: 10px;
        }
        .tab-container {
            margin-bottom: 20px;
        }
        .tab-buttons {
            display: flex;
            border-bottom: 1px solid #ccc;
        }
        .tab-button {
            padding: 10px 15px;
            background-color: #f1f1f1;
            border: none;
            cursor: pointer;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .tab-button.active {
            background-color: #4CAF50;
            color: white;
        }
        .tab-content {
            display: none;
            padding: 15px;
            border: 1px solid #ccc;
            border-top: none;
        }
        .tab-content.active {
            display: block;
        }
        .nav-links {
            margin-bottom: 20px;
        }
        .nav-links a {
            display: inline-block;
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            margin-right: 10px;
        }
        .nav-links a:hover {
            background-color: #0056b3;
        }
        
        /* 新增开关样式 */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }
        
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #4CAF50;
        }
        
        input:focus + .slider {
            box-shadow: 0 0 1px #4CAF50;
        }
        
        input:checked + .slider:before {
            transform: translateX(30px);
        }
        
        .switch-label {
            display: flex;
            align-items: center;
            margin-top: 10px;
        }
        
        .switch-label span {
            margin-left: 10px;
            font-weight: bold;
        }
        
        .secretary-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
    <div class="nav-links">
        <a href="index.html">首页</a>
        <a href="template_manager.html">模板管理器</a>
        <a href="secretary_manager.html">秘书任务管理器</a>
    </div>

    <h1>MCP秘书系统 - 秘书任务管理器</h1>
    
    <div id="alerts">
        <div id="errorAlert" class="error"></div>
        <div id="successAlert" class="success"></div>
    </div>
    
    <div class="container">
        <div class="panel">
            <h2>秘书管理</h2>
            <div class="form-group">
                <button id="loadSecretaries">加载所有秘书</button>
            </div>
            
            <div id="secretaryList"></div>
            
            <h3>创建新秘书</h3>
            <div class="form-group">
                <label for="secretaryName">名称</label>
                <input type="text" id="secretaryName" placeholder="输入秘书名称">
            </div>
            <div class="form-group">
                <label for="secretaryDesc">描述</label>
                <textarea id="secretaryDesc" placeholder="输入秘书描述"></textarea>
            </div>
            <div class="form-group">
                <button id="createSecretary">创建秘书</button>
            </div>
        </div>
        
        <div class="panel">
            <h2>任务管理</h2>
            <div class="form-group">
                <label for="secretarySelector">选择秘书</label>
                <select id="secretarySelector">
                    <option value="">请先加载秘书列表</option>
                </select>
            </div>
            <div class="form-group">
                <button id="loadTasks">加载所选秘书的任务</button>
            </div>
            
            <div id="taskList"></div>
            
            <h3>创建新任务</h3>
            <div class="form-group">
                <label for="taskName">任务名称</label>
                <input type="text" id="taskName" placeholder="输入任务名称">
            </div>
            <div class="form-group">
                <label for="templateSelector">选择模板</label>
                <select id="templateSelector">
                    <option value="">加载中...</option>
                </select>
            </div>
            <div class="form-group">
                <button id="createTask">创建任务</button>
            </div>
            <div class="form-group">
                <div id="customParamsContainer"></div>
            </div>
        </div>
    </div>
    
    <div class="panel">
        <h2>模板管理</h2>
        <div class="form-group">
            <button id="loadTemplates">加载所有模板</button>
        </div>
        
        <div id="templateList"></div>
    </div>
    
    <div class="panel">
        <h2>API响应</h2>
        <div class="request-log" id="requestLog"></div>
        <pre id="apiResponse">点击任意操作按钮查看API响应...</pre>
    </div>

    <div class="panel">
        <h2>用户-秘书关联管理</h2>
        <div class="form-group">
            <label for="userIdInput">用户ID</label>
            <input type="text" id="userIdInput" placeholder="输入用户ID">
        </div>
        <div class="form-group">
            <label for="userSecretarySelector">选择要关联的秘书</label>
            <select id="userSecretarySelector">
                <option value="">请先加载秘书列表</option>
            </select>
        </div>
        <div class="form-group">
            <button id="registerUserSecretary">关联用户与秘书</button>
            <button id="getUserSecretary">查询用户关联的秘书</button>
            <button id="unregisterUser" style="background-color: #f44336;">解除用户关联</button>
        </div>
        <div id="userSecretaryResult"></div>
    </div>

    <script>
        // API基础URL - 确保与后端匹配
        const API_BASE_URL = window.location.origin + '/api';
        
        // DOM元素引用
        const errorAlert = document.getElementById('errorAlert');
        const successAlert = document.getElementById('successAlert');
        const apiResponse = document.getElementById('apiResponse');
        const requestLog = document.getElementById('requestLog');
        const secretaryList = document.getElementById('secretaryList');
        const taskList = document.getElementById('taskList');
        const templateList = document.getElementById('templateList');
        const secretarySelector = document.getElementById('secretarySelector');
        const templateSelector = document.getElementById('templateSelector');
        
        // 显示错误信息
        function showError(message) {
            errorAlert.textContent = message;
            errorAlert.style.display = 'block';
            setTimeout(() => {
                errorAlert.style.display = 'none';
            }, 5000);
        }
        
        // 显示成功信息
        function showSuccess(message) {
            successAlert.textContent = message;
            successAlert.style.display = 'block';
            setTimeout(() => {
                successAlert.style.display = 'none';
            }, 3000);
        }
        
        // 显示API响应
        function displayApiResponse(data) {
            apiResponse.textContent = JSON.stringify(data, null, 2);
        }
        
        // 记录请求日志
        function logRequest(method, url, data) {
            const timestamp = new Date().toLocaleTimeString();
            requestLog.innerHTML = `${timestamp} - ${method} ${url}${data ? ' ' + JSON.stringify(data) : ''}<br>` + requestLog.innerHTML;
        }
        
        // 通用API请求函数
        async function fetchApi(endpoint, method = 'GET', data = null) {
            const url = `${API_BASE_URL}${endpoint}`;
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            };
            
            if (data && (method === 'POST' || method === 'PUT')) {
                options.body = JSON.stringify(data);
            }
            
            logRequest(method, url, data);
            
            const response = await fetch(url, options);
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText || `请求失败，状态码：${response.status}`);
            }
            
            if (response.status === 204) {
                return null; // 204 No Content
            }
            
            return response.json();
        }
        
        // ========== 秘书相关操作 ==========
        
        // 加载所有秘书
        async function loadSecretaries() {
            try {
                const secretaries = await fetchApi('/secretaries');
                displayApiResponse(secretaries);
                
                // 清空现有列表
                secretaryList.innerHTML = '';
                secretarySelector.innerHTML = '<option value="">选择秘书</option>';
                
                // 清空用户-秘书选择器
                const userSecretarySelector = document.getElementById('userSecretarySelector');
                userSecretarySelector.innerHTML = '<option value="">选择秘书</option>';
                
                // 填充秘书列表
                secretaries.forEach(secretary => {
                    // 添加到秘书列表
                    const secretaryItem = document.createElement('div');
                    secretaryItem.className = 'list-item';
                    
                    // 创建开关HTML
                    const switchHtml = `
                        <div class="switch-label">
                            <label class="switch">
                                <input type="checkbox" class="secretary-toggle" data-id="${secretary.id}" 
                                    ${secretary.active ? 'checked' : ''} 
                                    onchange="toggleSecretaryStatus('${secretary.id}', this.checked)">
                                <span class="slider"></span>
                            </label>
                            <span>${secretary.active ? '已激活' : '未激活'}</span>
                        </div>
                    `;
                    
                    // 创建完整的秘书项目HTML
                    secretaryItem.innerHTML = `
                        <div class="secretary-header">
                            <h3>${secretary.name}</h3>
                            ${switchHtml}
                        </div>
                        <p>${secretary.description || '无描述'}</p>
                        <div class="actions">
                            <button onclick="viewSecretary('${secretary.id}')">查看详情</button>
                            <button onclick="deleteSecretary('${secretary.id}')" style="background-color: #f44336;">删除</button>
                        </div>
                    `;
                    secretaryList.appendChild(secretaryItem);
                    
                    // 添加到下拉选择框
                    const option = document.createElement('option');
                    option.value = secretary.id;
                    option.textContent = secretary.name;
                    secretarySelector.appendChild(option);
                    
                    // 添加到用户-秘书选择框
                    const userOption = document.createElement('option');
                    userOption.value = secretary.id;
                    userOption.textContent = secretary.name;
                    userSecretarySelector.appendChild(userOption);
                });
                
                showSuccess('成功加载秘书列表');
            } catch (error) {
                console.error('加载秘书失败:', error);
                showError(`加载秘书失败: ${error.message}`);
            }
        }
        
        // 秘书状态切换处理函数
        async function toggleSecretaryStatus(id, isActive) {
            try {
                if (isActive) {
                    await activateSecretary(id);
                } else {
                    await deactivateSecretary(id);
                }
                
                // 更新开关旁边的文字
                const toggleLabel = document.querySelector(`.secretary-toggle[data-id="${id}"]`).parentNode.nextElementSibling;
                toggleLabel.textContent = isActive ? '已激活' : '未激活';
            } catch (error) {
                console.error('切换秘书状态失败:', error);
                showError(`切换秘书状态失败: ${error.message}`);
            }
        }
        
        // 查看秘书详情
        async function viewSecretary(id) {
            try {
                const secretary = await fetchApi(`/secretaries/${id}`);
                displayApiResponse(secretary);
                showSuccess('成功获取秘书详情');
            } catch (error) {
                console.error('获取秘书详情失败:', error);
                showError(`获取秘书详情失败: ${error.message}`);
            }
        }
        
        // 激活秘书
        async function activateSecretary(id) {
            try {
                const secretary = await fetchApi(`/secretaries/${id}/activate`, 'POST');
                displayApiResponse(secretary);
                showSuccess('秘书激活成功');
                loadSecretaries(); // 重新加载列表
            } catch (error) {
                console.error('激活秘书失败:', error);
                showError(`激活秘书失败: ${error.message}`);
            }
        }
        
        // 停用秘书
        async function deactivateSecretary(id) {
            try {
                const secretary = await fetchApi(`/secretaries/${id}/deactivate`, 'POST');
                displayApiResponse(secretary);
                showSuccess('秘书停用成功');
                loadSecretaries(); // 重新加载列表
            } catch (error) {
                console.error('停用秘书失败:', error);
                showError(`停用秘书失败: ${error.message}`);
            }
        }
        
        // 删除秘书
        async function deleteSecretary(id) {
            if (!confirm('确定要删除这个秘书吗？此操作不可撤销。')) {
                return;
            }
            
            try {
                await fetchApi(`/secretaries/${id}`, 'DELETE');
                showSuccess('秘书删除成功');
                displayApiResponse({ success: true, message: '秘书删除成功' });
                loadSecretaries(); // 重新加载列表
            } catch (error) {
                console.error('删除秘书失败:', error);
                showError(`删除秘书失败: ${error.message}`);
            }
        }
        
        // 创建新秘书
        async function createSecretary() {
            const name = document.getElementById('secretaryName').value.trim();
            const description = document.getElementById('secretaryDesc').value.trim();
            
            if (!name) {
                showError('秘书名称不能为空');
                return;
            }
            
            try {
                const newSecretary = await fetchApi('/secretaries', 'POST', {
                    name,
                    description
                });
                
                displayApiResponse(newSecretary);
                showSuccess('秘书创建成功');
                
                // 清空表单
                document.getElementById('secretaryName').value = '';
                document.getElementById('secretaryDesc').value = '';
                
                // 重新加载列表
                loadSecretaries();
            } catch (error) {
                console.error('创建秘书失败:', error);
                showError(`创建秘书失败: ${error.message}`);
            }
        }
        
        // ========== 任务相关操作 ==========
        
        // 加载秘书的任务
        async function loadTasks() {
            const secretaryId = secretarySelector.value;
            
            if (!secretaryId) {
                showError('请先选择一个秘书');
                return;
            }
            
            try {
                const tasks = await fetchApi(`/secretaries/${secretaryId}/tasks`);
                displayApiResponse(tasks);
                
                // 清空现有列表
                taskList.innerHTML = '';
                
                if (tasks.length === 0) {
                    taskList.innerHTML = '<p>该秘书暂无任务</p>';
                    return;
                }
                
                // 填充任务列表
                tasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.className = 'list-item';
                    
                    // 创建开关HTML
                    const switchHtml = `
                        <div class="switch-label">
                            <label class="switch">
                                <input type="checkbox" class="task-toggle" data-id="${task.id}" 
                                    ${task.active ? 'checked' : ''} 
                                    onchange="toggleTaskStatus('${task.id}', '${secretaryId}', this.checked)">
                                <span class="slider"></span>
                            </label>
                            <span>${task.active ? '已激活' : '未激活'}</span>
                        </div>
                    `;
                    
                    // 创建完整的任务项目HTML
                    taskItem.innerHTML = `
                        <div class="secretary-header">
                            <h3>${task.name}</h3>
                            ${switchHtml}
                        </div>
                        <p>模板: ${task.templateId}</p>
                        <div class="actions">
                            <button onclick="viewTask('${task.id}', '${secretaryId}')">查看详情</button>
                            <button onclick="deleteTask('${task.id}', '${secretaryId}')" style="background-color: #f44336;">删除</button>
                        </div>
                    `;
                    taskList.appendChild(taskItem);
                });
                
                showSuccess('成功加载任务列表');
            } catch (error) {
                console.error('加载任务失败:', error);
                showError(`加载任务失败: ${error.message}`);
            }
        }
        
        // 任务状态切换处理函数
        async function toggleTaskStatus(taskId, secretaryId, isActive) {
            try {
                if (isActive) {
                    await activateTask(taskId, secretaryId);
                } else {
                    await deactivateTask(taskId, secretaryId);
                }
                
                // 更新开关旁边的文字
                const toggleLabel = document.querySelector(`.task-toggle[data-id="${taskId}"]`).parentNode.nextElementSibling;
                toggleLabel.textContent = isActive ? '已激活' : '未激活';
            } catch (error) {
                console.error('切换任务状态失败:', error);
                showError(`切换任务状态失败: ${error.message}`);
                
                // 还原开关状态
                const toggleCheckbox = document.querySelector(`.task-toggle[data-id="${taskId}"]`);
                toggleCheckbox.checked = !isActive;
                toggleCheckbox.parentNode.nextElementSibling.textContent = !isActive ? '已激活' : '未激活';
            }
        }
        
        // 查看任务详情
        async function viewTask(taskId, secretaryId) {
            try {
                const task = await fetchApi(`/tasks/${taskId}?secretaryId=${secretaryId}`);
                displayApiResponse(task);
                showSuccess('成功获取任务详情');
            } catch (error) {
                console.error('获取任务详情失败:', error);
                showError(`获取任务详情失败: ${error.message}`);
            }
        }
        
        // 激活任务
        async function activateTask(taskId, secretaryId) {
            try {
                const task = await fetchApi(`/tasks/${taskId}/activate?secretaryId=${secretaryId}`, 'POST');
                displayApiResponse(task);
                showSuccess('任务激活成功');
                loadTasks(); // 重新加载列表
            } catch (error) {
                console.error('激活任务失败:', error);
                showError(`激活任务失败: ${error.message}`);
            }
        }
        
        // 停用任务
        async function deactivateTask(taskId, secretaryId) {
            try {
                const task = await fetchApi(`/tasks/${taskId}/deactivate?secretaryId=${secretaryId}`, 'POST');
                displayApiResponse(task);
                showSuccess('任务停用成功');
                loadTasks(); // 重新加载列表
            } catch (error) {
                console.error('停用任务失败:', error);
                showError(`停用任务失败: ${error.message}`);
            }
        }
        
        // 删除任务
        async function deleteTask(taskId, secretaryId) {
            if (!confirm('确定要删除这个任务吗？此操作不可撤销。')) {
                return;
            }
            
            try {
                await fetchApi(`/tasks/${taskId}?secretaryId=${secretaryId}`, 'DELETE');
                showSuccess('任务删除成功');
                displayApiResponse({ success: true, message: '任务删除成功' });
                loadTasks(); // 重新加载列表
            } catch (error) {
                console.error('删除任务失败:', error);
                showError(`删除任务失败: ${error.message}`);
            }
        }
        
        // 创建新任务
        async function createTask() {
            const secretaryId = secretarySelector.value;
            const templateId = templateSelector.value;
            const name = document.getElementById('taskName').value.trim();
            
            if (!secretaryId || !templateId || !name) {
                showError('请填写所有必填字段');
                return;
            }
            
            try {
                // 首先创建基本任务
                const newTask = await fetchApi('/tasks', 'POST', {
                    secretaryId,
                    templateId,
                    name
                });
                
                // 收集自定义参数值
                const template = await fetchApi(`/templates/${templateId}`);
                const customParams = {};
                
                if (template.customizableParams) {
                    template.customizableParams.forEach(param => {
                        const inputElement = document.getElementById(`param-${param.name}`);
                        if (!inputElement) return;
                        
                        // 根据参数类型获取值
                        if (param.category === 'STDIO_ARG') {
                            customParams[param.name] = inputElement.checked;
                        } else {
                            customParams[param.name] = inputElement.value;
                        }
                    });
                }
                
                // 应用自定义参数
                if (Object.keys(customParams).length > 0) {
                    await applyCustomParams(newTask.id, secretaryId, customParams);
                }
                
                displayApiResponse(newTask);
                showSuccess('任务创建成功并应用了自定义参数');
                
                // 清空表单
                document.getElementById('taskName').value = '';
                document.getElementById('customParamsContainer').innerHTML = '';
                
                // 重新加载列表
                loadTasks();
            } catch (error) {
                console.error('创建任务失败:', error);
                showError(`创建任务失败: ${error.message}`);
            }
        }
        
        // ========== 模板相关操作 ==========
        
        // 加载所有模板
        async function loadTemplates() {
            try {
                const templates = await fetchApi('/templates');
                displayApiResponse(templates);
                
                // 清空现有列表
                templateList.innerHTML = '';
                templateSelector.innerHTML = '<option value="">选择模板</option>';
                
                // 填充模板列表和选择器
                templates.forEach(template => {
                    // 添加到模板列表
                    const templateItem = document.createElement('div');
                    templateItem.className = 'list-item';
                    templateItem.innerHTML = `
                        <h3>${template.name}</h3>
                        <p>${template.description || '无描述'}</p>
                        <div class="actions">
                            <button onclick="viewTemplate('${template.id}')">查看详情</button>
                        </div>
                    `;
                    templateList.appendChild(templateItem);
                    
                    // 添加到下拉选择框
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    templateSelector.appendChild(option);
                });
                
                showSuccess('成功加载模板列表');
            } catch (error) {
                console.error('加载模板失败:', error);
                showError(`加载模板失败: ${error.message}`);
            }
        }
        
        // 查看模板详情
        async function viewTemplate(id) {
            try {
                const template = await fetchApi(`/templates/${id}`);
                displayApiResponse(template);
                showSuccess('成功获取模板详情');
            } catch (error) {
                console.error('获取模板详情失败:', error);
                showError(`获取模板详情失败: ${error.message}`);
            }
        }
        
        // 在选择模板后，加载该模板的自定义参数
        async function loadTemplateParams() {
            const templateId = templateSelector.value;
            
            if (!templateId) {
                document.getElementById('customParamsContainer').innerHTML = '';
                return;
            }
            
            try {
                const template = await fetchApi(`/templates/${templateId}`);
                const customizableParams = template.customizableParams || [];
                
                // 生成参数配置表单
                const container = document.getElementById('customParamsContainer');
                container.innerHTML = '';
                
                if (customizableParams.length === 0) {
                    container.innerHTML = '<p>此模板没有可自定义参数</p>';
                    return;
                }
                
                // 添加标题
                const title = document.createElement('h4');
                title.textContent = '自定义参数配置';
                container.appendChild(title);
                
                // 为每个参数创建适当的输入控件
                customizableParams.forEach(param => {
                    const formGroup = document.createElement('div');
                    formGroup.className = 'form-group';
                    
                    const label = document.createElement('label');
                    label.setAttribute('for', `param-${param.name}`);
                    label.textContent = param.displayName || param.name;
                    
                    const description = document.createElement('small');
                    description.style.display = 'block';
                    description.style.color = '#666';
                    description.textContent = param.description || '';
                    
                    formGroup.appendChild(label);
                    formGroup.appendChild(description);
                    
                    // 根据参数类型创建不同控件
                    switch (param.category) {
                        case 'STDIO_ARG':
                            // 创建开关控件
                            const switchLabel = document.createElement('div');
                            switchLabel.className = 'switch-label';
                            switchLabel.innerHTML = `
                                <label class="switch">
                                    <input type="checkbox" id="param-${param.name}" 
                                        ${param.defaultValue ? 'checked' : ''}>
                                    <span class="slider"></span>
                                </label>
                                <span>${param.defaultValue ? '启用' : '禁用'}</span>
                            `;
                            formGroup.appendChild(switchLabel);
                            break;
                            
                        case 'SSE_AUTH_PARAM':
                            // 判断是否是密码类型的参数
                            const isPassword = param.name === 'apiKey' || 
                                              param.name.toLowerCase().includes('key') || 
                                              param.name.toLowerCase().includes('token') || 
                                              param.name.toLowerCase().includes('secret');
                            
                            // 创建文本输入框或密码输入框
                            const authInput = document.createElement('input');
                            authInput.type = isPassword ? 'password' : 'text';
                            authInput.id = `param-${param.name}`;
                            authInput.placeholder = `输入${param.displayName || param.name}`;
                            authInput.value = param.defaultValue || '';
                            formGroup.appendChild(authInput);
                            break;
                            
                        case 'STDIO_ENV':
                        default:
                            // 创建文本输入框
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.id = `param-${param.name}`;
                            input.placeholder = `输入${param.displayName || param.name}`;
                            input.value = param.defaultValue || '';
                            formGroup.appendChild(input);
                            break;
                    }
                    
                    container.appendChild(formGroup);
                });
            } catch (error) {
                console.error('加载模板参数失败:', error);
                showError(`加载模板参数失败: ${error.message}`);
            }
        }
        
        // ========== 任务配置操作 ==========
        
        // 更新任务配置
        async function updateTaskConfig(taskId, secretaryId, configUpdates) {
            try {
                const task = await fetchApi(`/tasks/${taskId}/config?secretaryId=${secretaryId}`, 'PUT', configUpdates);
                displayApiResponse(task);
                showSuccess('任务配置更新成功');
                return task;
            } catch (error) {
                console.error('更新任务配置失败:', error);
                showError(`更新任务配置失败: ${error.message}`);
                throw error;
            }
        }
        
        // 应用自定义参数
        async function applyCustomParams(taskId, secretaryId, customParams) {
            try {
                const task = await fetchApi(`/tasks/${taskId}/customParams?secretaryId=${secretaryId}`, 'PUT', customParams);
                displayApiResponse(task);
                showSuccess('自定义参数应用成功');
                return task;
            } catch (error) {
                console.error('应用自定义参数失败:', error);
                showError(`应用自定义参数失败: ${error.message}`);
                throw error;
            }
        }
        
        // 更新连接配置
        async function updateConnectionProfile(taskId, secretaryId, connectionProfile) {
            try {
                const task = await fetchApi(`/tasks/${taskId}/connectionProfile?secretaryId=${secretaryId}`, 'PUT', connectionProfile);
                displayApiResponse(task);
                showSuccess('连接配置更新成功');
                return task;
            } catch (error) {
                console.error('更新连接配置失败:', error);
                showError(`更新连接配置失败: ${error.message}`);
                throw error;
            }
        }
        
        // ========== 用户-秘书关联操作 ==========
        
        // 关联用户与秘书
        async function registerUserSecretary() {
            const userId = document.getElementById('userIdInput').value.trim();
            const secretaryName = document.getElementById('userSecretarySelector').options[
                document.getElementById('userSecretarySelector').selectedIndex
            ].text;
            
            if (!userId) {
                showError('用户ID不能为空');
                return;
            }
            
            if (!secretaryName) {
                showError('请选择要关联的秘书');
                return;
            }
            
            try {
                await fetchApi(`/user-secretary/register?userId=${encodeURIComponent(userId)}&secretaryName=${encodeURIComponent(secretaryName)}`, 'POST');
                
                displayApiResponse({
                    success: true,
                    message: `用户 ${userId} 已成功关联到秘书 ${secretaryName}`
                });
                
                showSuccess(`用户 ${userId} 已成功关联到秘书 ${secretaryName}`);
                
                // 更新显示结果
                document.getElementById('userSecretaryResult').innerHTML = 
                    `<div class="success" style="display:block;">用户 ${userId} 已关联到秘书: ${secretaryName}</div>`;
            } catch (error) {
                console.error('关联用户与秘书失败:', error);
                showError(`关联用户与秘书失败: ${error.message}`);
            }
        }
        
        // 查询用户关联的秘书
        async function getUserSecretary() {
            const userId = document.getElementById('userIdInput').value.trim();
            
            if (!userId) {
                showError('用户ID不能为空');
                return;
            }
            
            try {
                const response = await fetchApi(`/user-secretary/secretary?userId=${encodeURIComponent(userId)}`, 'GET');
                
                displayApiResponse({
                    userId: userId,
                    secretaryName: response
                });
                
                // 更新显示结果
                if (response) {
                    document.getElementById('userSecretaryResult').innerHTML = 
                        `<div class="success" style="display:block;">用户 ${userId} 当前关联的秘书: ${response}</div>`;
                    showSuccess(`查询成功，用户 ${userId} 已关联到秘书 ${response}`);
                    
                    // 自动选择下拉框中对应的秘书
                    const selector = document.getElementById('userSecretarySelector');
                    for (let i = 0; i < selector.options.length; i++) {
                        if (selector.options[i].text === response) {
                            selector.selectedIndex = i;
                            break;
                        }
                    }
                } else {
                    document.getElementById('userSecretaryResult').innerHTML = 
                        `<div class="error" style="display:block;">用户 ${userId} 当前未关联任何秘书</div>`;
                    showSuccess(`查询成功，用户 ${userId} 未关联任何秘书`);
                }
            } catch (error) {
                console.error('查询用户关联的秘书失败:', error);
                showError(`查询用户关联的秘书失败: ${error.message}`);
                
                // 如果是404错误，显示未关联信息
                if (error.message.includes('404')) {
                    document.getElementById('userSecretaryResult').innerHTML = 
                        `<div class="error" style="display:block;">用户 ${userId} 当前未关联任何秘书</div>`;
                }
            }
        }
        
        // 解除用户关联
        async function unregisterUser() {
            const userId = document.getElementById('userIdInput').value.trim();
            
            if (!userId) {
                showError('用户ID不能为空');
                return;
            }
            
            if (!confirm(`确定要解除用户 ${userId} 的秘书关联吗？`)) {
                return;
            }
            
            try {
                await fetchApi(`/user-secretary/unregister?userId=${encodeURIComponent(userId)}`, 'DELETE');
                
                displayApiResponse({
                    success: true,
                    message: `用户 ${userId} 的秘书关联已成功解除`
                });
                
                showSuccess(`用户 ${userId} 的秘书关联已成功解除`);
                
                // 更新显示结果
                document.getElementById('userSecretaryResult').innerHTML = 
                    `<div class="success" style="display:block;">用户 ${userId} 的秘书关联已解除</div>`;
            } catch (error) {
                console.error('解除用户关联失败:', error);
                showError(`解除用户关联失败: ${error.message}`);
            }
        }
        
        // ========== 事件监听 ==========
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 绑定按钮事件
            document.getElementById('loadSecretaries').addEventListener('click', loadSecretaries);
            document.getElementById('createSecretary').addEventListener('click', createSecretary);
            document.getElementById('loadTasks').addEventListener('click', loadTasks);
            document.getElementById('createTask').addEventListener('click', createTask);
            document.getElementById('loadTemplates').addEventListener('click', loadTemplates);
            
            // 绑定用户-秘书关联按钮事件
            document.getElementById('registerUserSecretary').addEventListener('click', registerUserSecretary);
            document.getElementById('getUserSecretary').addEventListener('click', getUserSecretary);
            document.getElementById('unregisterUser').addEventListener('click', unregisterUser);
            
            // 自动加载模板列表
            loadTemplates();
        });

        // 添加模板选择器的变更事件
        document.getElementById('templateSelector').addEventListener('change', loadTemplateParams);
    </script>
</body>
</html>