<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP秘书系统 - API测试</title>
    <style>
        /* 保持原有样式不变 */
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
        }
        .panel {
            flex: 1;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
        }
        h2 {
            margin-top: 0;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, textarea, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            text-align: center;
            cursor: pointer;
            border-radius: 4px;
        }
        button:hover {
            background-color: #45a049;
        }
        .list-item {
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .list-item:hover {
            background-color: #f9f9f9;
        }
        .list-item h3 {
            margin-top: 0;
            margin-bottom: 5px;
        }
        .actions {
            margin-top: 10px;
        }
        .error {
            color: #D8000C;
            background-color: #FFBABA;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }
        .success {
            color: #4F8A10;
            background-color: #DFF2BF;
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            display: none;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow: auto;
        }
        .request-log {
            margin-top: 10px;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>MCP秘书系统 API测试</h1>
    
    <div id="alerts">
        <div id="errorAlert" class="error"></div>
        <div id="successAlert" class="success"></div>
    </div>
    
    <div class="container">
        <div class="panel">
            <h2>秘书管理</h2>
            <div class="form-group">
                <button id="loadSecretaries">加载所有秘书</button>
            </div>
            
            <div id="secretaryList"></div>
            
            <h3>创建新秘书</h3>
            <div class="form-group">
                <label for="secretaryName">名称</label>
                <input type="text" id="secretaryName" placeholder="输入秘书名称">
            </div>
            <div class="form-group">
                <label for="secretaryDesc">描述</label>
                <textarea id="secretaryDesc" placeholder="输入秘书描述"></textarea>
            </div>
            <div class="form-group">
                <button id="createSecretary">创建秘书</button>
            </div>
        </div>
        
        <div class="panel">
            <h2>任务管理</h2>
            <div class="form-group">
                <label for="secretarySelector">选择秘书</label>
                <select id="secretarySelector">
                    <option value="">请先加载秘书列表</option>
                </select>
            </div>
            <div class="form-group">
                <button id="loadTasks">加载所选秘书的任务</button>
            </div>
            
            <div id="taskList"></div>
            
            <h3>创建新任务</h3>
            <div class="form-group">
                <label for="taskName">任务名称</label>
                <input type="text" id="taskName" placeholder="输入任务名称">
            </div>
            <div class="form-group">
                <label for="templateSelector">选择模板</label>
                <select id="templateSelector">
                    <option value="">加载中...</option>
                </select>
            </div>
            <div class="form-group">
                <button id="createTask">创建任务</button>
            </div>
        </div>
    </div>
    
    <div class="panel">
        <h2>模板管理</h2>
        <div class="form-group">
            <button id="loadTemplates">加载所有模板</button>
        </div>
        
        <div id="templateList"></div>
    </div>
    
    <div class="panel">
        <h2>API响应</h2>
        <div class="request-log" id="requestLog"></div>
        <pre id="apiResponse">点击任意操作按钮查看API响应...</pre>
    </div>

    <script>
        // API基础URL - 确保与后端匹配
        const API_BASE_URL = 'http://localhost:8080/api';
        
        // DOM元素引用
        const errorAlert = document.getElementById('errorAlert');
        const successAlert = document.getElementById('successAlert');
        const apiResponse = document.getElementById('apiResponse');
        const requestLog = document.getElementById('requestLog');
        const secretaryList = document.getElementById('secretaryList');
        const taskList = document.getElementById('taskList');
        const templateList = document.getElementById('templateList');
        const secretarySelector = document.getElementById('secretarySelector');
        const templateSelector = document.getElementById('templateSelector');
        
        // 显示错误信息
        function showError(message) {
            errorAlert.textContent = message;
            errorAlert.style.display = 'block';
            setTimeout(() => {
                errorAlert.style.display = 'none';
            }, 5000);
        }
        
        // 显示成功信息
        function showSuccess(message) {
            successAlert.textContent = message;
            successAlert.style.display = 'block';
            setTimeout(() => {
                successAlert.style.display = 'none';
            }, 3000);
        }
        
        // 显示API响应
        function displayApiResponse(data) {
            apiResponse.textContent = JSON.stringify(data, null, 2);
        }
        
        // 记录请求日志
        function logRequest(method, url, body, status, response) {
            const timestamp = new Date().toLocaleTimeString();
            const log = `${timestamp} - ${method} ${url} - 状态: ${status}\n`;
            requestLog.textContent = log + requestLog.textContent;
            
            console.log(`API请求: ${method} ${url}`);
            if (body) console.log('请求体:', body);
            console.log(`响应状态: ${status}`);
            console.log('响应内容:', response);
        }
        
        // 执行API请求
        async function fetchApi(endpoint, method = 'GET', body = null) {
            const url = `${API_BASE_URL}${endpoint}`;
            try {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'include' // 包含cookies
                };
                
                if (body) {
                    options.body = JSON.stringify(body);
                }
                
                // 记录请求日志
                console.log(`发送${method}请求到: ${url}`, body);
                
                const response = await fetch(url, options);
                
                let responseData;
                let responseText = '';
                
                try {
                    responseText = await response.text();
                    if (responseText) {
                        responseData = JSON.parse(responseText);
                    }
                } catch (e) {
                    responseData = { text: responseText };
                    console.warn('无法解析响应为JSON:', e);
                }
                
                // 记录响应日志
                logRequest(method, url, body, response.status, responseData || responseText);
                
                if (!response.ok) {
                    throw new Error(
                        responseData?.message || 
                        responseData?.error || 
                        `API错误: ${response.status} - ${responseText}`
                    );
                }
                
                // 204 No Content不需要解析JSON
                if (response.status === 204) {
                    return { success: true, statusCode: 204 };
                }
                
                return responseData;
            } catch (error) {
                console.error('API请求失败:', error);
                showError(`请求失败: ${error.message}`);
                throw error;
            }
        }
        
        // 加载所有秘书
        async function loadSecretaries() {
            try {
                const secretaries = await fetchApi('/secretaries');
                displayApiResponse(secretaries);
                
                // 清空现有列表
                secretaryList.innerHTML = '';
                secretarySelector.innerHTML = '<option value="">选择秘书</option>';
                
                // 填充秘书列表
                secretaries.forEach(secretary => {
                    // 添加到秘书列表
                    const secretaryItem = document.createElement('div');
                    secretaryItem.className = 'list-item';
                    secretaryItem.innerHTML = `
                        <h3>${secretary.name}</h3>
                        <p>${secretary.description || '无描述'}</p>
                        <div class="actions">
                            <button onclick="viewSecretary('${secretary.id}')">查看详情</button>
                            <button onclick="activateSecretary('${secretary.id}')">激活</button>
                            <button onclick="deactivateSecretary('${secretary.id}')">停用</button>
                            <button onclick="deleteSecretary('${secretary.id}')" style="background-color: #f44336;">删除</button>
                        </div>
                    `;
                    secretaryList.appendChild(secretaryItem);
                    
                    // 添加到下拉选择框
                    const option = document.createElement('option');
                    option.value = secretary.id;
                    option.textContent = secretary.name;
                    secretarySelector.appendChild(option);
                });
                
                showSuccess('成功加载秘书列表');
            } catch (error) {
                console.error('加载秘书失败:', error);
                displayApiResponse({ error: error.message });
            }
        }
        
        // 查看秘书详情
        async function viewSecretary(id) {
            try {
                const secretary = await fetchApi(`/secretaries/${id}`);
                displayApiResponse(secretary);
            } catch (error) {
                console.error('获取秘书详情失败:', error);
                displayApiResponse({ error: error.message });
            }
        }
        
        // 激活秘书
        async function activateSecretary(id) {
            try {
                const result = await fetchApi(`/secretaries/${id}/activate`, 'POST');
                displayApiResponse(result);
                showSuccess('秘书激活成功');
                loadSecretaries(); // 重新加载列表
            } catch (error) {
                console.error('激活秘书失败:', error);
                displayApiResponse({ error: error.message });
            }
        }
        
        // 停用秘书
        async function deactivateSecretary(id) {
            try {
                const result = await fetchApi(`/secretaries/${id}/deactivate`, 'POST');
                displayApiResponse(result);
                showSuccess('秘书停用成功');
                loadSecretaries(); // 重新加载列表
            } catch (error) {
                console.error('停用秘书失败:', error);
                displayApiResponse({ error: error.message });
            }
        }
        
        // 删除秘书
        async function deleteSecretary(id) {
            if (!confirm('确定要删除这个秘书吗？此操作不可撤销。')) {
                return;
            }
            
            try {
                await fetchApi(`/secretaries/${id}`, 'DELETE');
                showSuccess('秘书删除成功');
                displayApiResponse({ success: true, message: '秘书删除成功' });
                loadSecretaries(); // 重新加载列表
            } catch (error) {
                console.error('删除秘书失败:', error);
                displayApiResponse({ error: error.message });
            }
        }
        
        // 创建新秘书
        async function createSecretary() {
            const name = document.getElementById('secretaryName').value.trim();
            const description = document.getElementById('secretaryDesc').value.trim();
            
            if (!name) {
                showError('秘书名称不能为空');
                return;
            }
            
            try {
                const newSecretary = await fetchApi('/secretaries', 'POST', {
                    name,
                    description
                });
                
                displayApiResponse(newSecretary);
                showSuccess('秘书创建成功');
                
                // 清空表单
                document.getElementById('secretaryName').value = '';
                document.getElementById('secretaryDesc').value = '';
                
                // 重新加载列表
                loadSecretaries();
            } catch (error) {
                console.error('创建秘书失败:', error);
                displayApiResponse({ error: error.message });
            }
        }
        
        // 加载秘书的任务
        async function loadTasks() {
            const secretaryId = secretarySelector.value;
            
            if (!secretaryId) {
                showError('请先选择一个秘书');
                return;
            }
            
            try {
                const tasks = await fetchApi(`/secretaries/${secretaryId}/tasks`);
                displayApiResponse(tasks);
                
                // 清空任务列表
                taskList.innerHTML = '';
                
                // 填充任务列表
                tasks.forEach(task => {
                    const taskItem = document.createElement('div');
                    taskItem.className = 'list-item';
                    taskItem.innerHTML = `
                        <h3>${task.name}</h3>
                        <p>状态: ${task.status || '未知'}</p>
                        <div class="actions">
                            <button onclick="viewTask('${task.id}', '${secretaryId}')">查看详情</button>
                            <button onclick="activateTask('${task.id}', '${secretaryId}')">激活</button>
                            <button onclick="deactivateTask('${task.id}', '${secretaryId}')">停用</button>
                            <button onclick="deleteTask('${task.id}', '${secretaryId}')" style="background-color: #f44336;">删除</button>
                        </div>
                    `;
                    taskList.appendChild(taskItem);
                });
                
                showSuccess('成功加载任务列表');
            } catch (error) {
                console.error('加载任务失败:', error);
                displayApiResponse({ error: error.message });
            }
        }
        
        // 查看任务详情
        async function viewTask(taskId, secretaryId) {
            try {
                const task = await fetchApi(`/tasks/${taskId}?secretaryId=${secretaryId}`);
                displayApiResponse(task);
            } catch (error) {
                console.error('获取任务详情失败:', error);
                displayApiResponse({ error: error.message });
            }
        }
        
        // 激活任务
        async function activateTask(taskId, secretaryId) {
            try {
                const result = await fetchApi(`/tasks/${taskId}/activate?secretaryId=${secretaryId}`, 'POST');
                displayApiResponse(result);
                showSuccess('任务激活成功');
                loadTasks(); // 重新加载列表
            } catch (error) {
                console.error('激活任务失败:', error);
                displayApiResponse({ error: error.message });
            }
        }
        
        // 停用任务
        async function deactivateTask(taskId, secretaryId) {
            try {
                const result = await fetchApi(`/tasks/${taskId}/deactivate?secretaryId=${secretaryId}`, 'POST');
                displayApiResponse(result);
                showSuccess('任务停用成功');
                loadTasks(); // 重新加载列表
            } catch (error) {
                console.error('停用任务失败:', error);
                displayApiResponse({ error: error.message });
            }
        }
        
        // 删除任务
        async function deleteTask(taskId, secretaryId) {
            if (!confirm('确定要删除这个任务吗？此操作不可撤销。')) {
                return;
            }
            
            try {
                await fetchApi(`/tasks/${taskId}?secretaryId=${secretaryId}`, 'DELETE');
                showSuccess('任务删除成功');
                displayApiResponse({ success: true, message: '任务删除成功' });
                loadTasks(); // 重新加载列表
            } catch (error) {
                console.error('删除任务失败:', error);
                displayApiResponse({ error: error.message });
            }
        }
        
        // 创建新任务
        async function createTask() {
            const secretaryId = secretarySelector.value;
            const templateId = templateSelector.value;
            const name = document.getElementById('taskName').value.trim();
            
            if (!secretaryId) {
                showError('请选择一个秘书');
                return;
            }
            
            if (!templateId) {
                showError('请选择一个模板');
                return;
            }
            
            if (!name) {
                showError('任务名称不能为空');
                return;
            }
            
            try {
                const newTask = await fetchApi('/tasks', 'POST', {
                    secretaryId,
                    templateId,
                    name
                });
                
                displayApiResponse(newTask);
                showSuccess('任务创建成功');
                
                // 清空表单
                document.getElementById('taskName').value = '';
                
                // 重新加载任务列表
                loadTasks();
            } catch (error) {
                console.error('创建任务失败:', error);
                displayApiResponse({ error: error.message });
            }
        }
        
        // 加载所有模板
        async function loadTemplates() {
            try {
                const templates = await fetchApi('/templates');
                displayApiResponse(templates);
                
                // 清空模板列表
                templateList.innerHTML = '';
                
                // 清空模板选择器
                templateSelector.innerHTML = '<option value="">选择模板</option>';
                
                // 填充模板列表和选择器
                templates.forEach(template => {
                    // 添加到模板列表
                    const templateItem = document.createElement('div');
                    templateItem.className = 'list-item';
                    templateItem.innerHTML = `
                        <h3>${template.name}</h3>
                        <p>${template.description || '无描述'}</p>
                        <div class="actions">
                            <button onclick="viewTemplate('${template.id}')">查看详情</button>
                        </div>
                    `;
                    templateList.appendChild(templateItem);
                    
                    // 添加到下拉选择框
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    templateSelector.appendChild(option);
                });
                
                showSuccess('成功加载模板列表');
            } catch (error) {
                console.error('加载模板失败:', error);
                displayApiResponse({ error: error.message });
            }
        }
        
        // 查看模板详情
        async function viewTemplate(id) {
            try {
                const template = await fetchApi(`/templates/${id}`);
                displayApiResponse(template);
            } catch (error) {
                console.error('获取模板详情失败:', error);
                displayApiResponse({ error: error.message });
            }
        }
        
        // 添加一个简单的尝试连接函数
        async function testConnection() {
            try {
                const result = await fetch(API_BASE_URL + '/secretaries', {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'include'
                });
                
                const status = result.status;
                let response = '';
                
                try {
                    response = await result.text();
                } catch (e) {
                    response = '无响应内容';
                }
                
                displayApiResponse({
                    status: status,
                    responseText: response
                });
                
                if (result.ok) {
                    showSuccess('连接测试成功!');
                } else {
                    showError(`连接测试失败: ${status}`);
                }
            } catch (error) {
                console.error('连接测试失败:', error);
                displayApiResponse({ error: error.message });
                showError(`连接测试失败: ${error.message}`);
            }
        }
        
        // 页面加载时执行
        document.addEventListener('DOMContentLoaded', function() {
            // 添加一个连接测试按钮
            const testButton = document.createElement('button');
            testButton.textContent = '测试API连接';
            testButton.style.marginBottom = '20px';
            testButton.style.backgroundColor = '#007bff';
            testButton.onclick = testConnection;
            document.body.insertBefore(testButton, document.body.firstChild);
            
            // 按钮事件监听
            document.getElementById('loadSecretaries').addEventListener('click', loadSecretaries);
            document.getElementById('createSecretary').addEventListener('click', createSecretary);
            document.getElementById('loadTasks').addEventListener('click', loadTasks);
            document.getElementById('createTask').addEventListener('click', createTask);
            document.getElementById('loadTemplates').addEventListener('click', loadTemplates);
            
            // 初始化 - 加载模板列表
            loadTemplates();
            
            // 初始化 - 尝试加载秘书列表
            setTimeout(() => {
                testConnection(); // 先测试连接
                setTimeout(() => loadSecretaries(), 1000); // 然后尝试加载秘书列表
            }, 500);
        });
        
        // 暴露函数给全局作用域，以便HTML中的onclick调用
        window.viewSecretary = viewSecretary;
        window.activateSecretary = activateSecretary;
        window.deactivateSecretary = deactivateSecretary;
        window.deleteSecretary = deleteSecretary;
        window.viewTask = viewTask;
        window.activateTask = activateTask;
        window.deactivateTask = deactivateTask;
        window.deleteTask = deleteTask;
        window.viewTemplate = viewTemplate;
        window.testConnection = testConnection;
    </script>
</body>
</html>